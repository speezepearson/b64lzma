<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <script src="static/lzma/lzma-d-min.js"></script>
  <script src="static/lzma/lzma_worker-min.js"></script>
  <script src="dist/main.js"></script>
</head>

<body>
  <div id="elm"></div>
  <script>
  function debugLog(...xs) {
    console.log(...xs)
  }
  function base64ToByteArray(base64) {
    var raw = window.atob(base64);
    var rawLength = raw.length;
    var array = new Uint8Array(new ArrayBuffer(rawLength));
    for(i = 0; i < rawLength; i++) {
      array[i] = raw.charCodeAt(i);
    }
    return array;
  }

  function zipToString(data, callback) {
    var array = base64ToByteArray(data);
    LZMA.decompress(array, function(result, error) {
      if (!(typeof result === 'string')) result = new Uint8Array(result)
      if (error) console.error(error);
      callback(result);
    });
  }

  var app = Elm.Main.init({
    node: document.getElementById('elm')
  });
  app.ports.decodeFragmentPort.subscribe(function(data) {
    debugLog("decoding", {data});
    if (data == "") {
      app.ports.fragmentDecodedPort.send("");
      return;
    }
    debugLog("decoding", {data});
    zipToString(data, function(decoded) {
        app.ports.fragmentDecodedPort.send({fragment: data, pageInfo: {title: "", body: decoded}});
        debugLog("decoded", {decoded});
    });
  });
  app.ports.encodePageInfoPort.subscribe(function(pageInfo) {
    LZMA.compress(pageInfo.body, 9, function(encoded, error) {
      if (error) console.error(error);
      var base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(encoded)));
      app.ports.pageInfoEncodedPort.send({fragment: base64String, pageInfo: pageInfo});
      debugLog("compressed", {base64String});
    });
  })

  window.addEventListener('paste', function(event) {
    var data = (event.clipboardData || window.clipboardData)
    var text = data.getData('text/html') || data.getData('text');
    app.ports.userPastedPort.send(text);
  });

  </script>
</body>
</html>
